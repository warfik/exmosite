<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Панель управления крипто-портфелем</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #111827; color: #e5e7eb; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 4px; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body class="p-4 sm:p-6 lg:p-8">

<div class="max-w-7xl mx-auto">
    <header class="mb-8">
        <h1 class="text-3xl font-bold text-white flex items-center">
            <i data-lucide="layout-dashboard" class="mr-3"></i>Панель управления портфелем
        </h1>
        <p class="text-gray-400 mt-1">Локальный сервер на Raspberry Pi</p>
    </header>

    <!-- Main Widgets Grid -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        <!-- Balance -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg fade-in">
            <div class="flex items-center justify-between"><h2 class="text-lg font-medium text-gray-300">Общий баланс</h2><div class="bg-blue-500/20 text-blue-400 p-2 rounded-lg"><i data-lucide="wallet"></i></div></div>
            <p id="total-balance-usd" class="text-4xl font-bold text-white mt-4">$0.00</p>
            <p id="total-balance-btc" class="text-lg text-gray-400 mt-1">~0.0000 BTC</p>
        </div>
        <!-- PnL -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg fade-in" style="animation-delay: 0.1s;">
            <div class="flex items-center justify-between"><h2 class="text-lg font-medium text-gray-300">Прибыль/Убыток (Общая)</h2><div id="pnl-icon-container" class="bg-gray-500/20 text-gray-400 p-2 rounded-lg"><i data-lucide="loader"></i></div></div>
            <p id="pnl-value" class="text-4xl font-bold mt-4">$0.00</p>
            <p id="pnl-percentage" class="text-lg mt-1">0.00%</p>
        </div>
        <!-- Trades -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg fade-in" style="animation-delay: 0.2s;">
            <h2 class="text-lg font-medium text-gray-300 mb-4">Сделки (24ч)</h2>
            <div class="flex items-center space-x-6"><div class="text-center"><p class="text-3xl font-bold text-green-500" id="buy-trades">0</p><p class="text-gray-400">Покупки</p></div><div class="text-center"><p class="text-3xl font-bold text-red-500" id="sell-trades">0</p><p class="text-gray-400">Продажи</p></div></div>
        </div>
        <!-- API Status -->
        <div class="bg-gray-800 p-6 rounded-xl shadow-lg fade-in" style="animation-delay: 0.3s;">
            <h2 class="text-lg font-medium text-gray-300 mb-4">Статус API</h2>
            <div class="flex items-center"><div id="api-status-indicator" class="w-3 h-3 rounded-full bg-yellow-500 mr-3 animate-pulse"></div><span id="api-status-text" class="text-white font-medium">Подключение...</span></div>
            <p class="text-sm text-gray-500 mt-2">Последнее обновление:</p><p id="last-update-time" class="text-sm text-gray-400">никогда</p>
        </div>

        <!-- Balance Chart Widget -->
        <div class="md:col-span-2 lg:col-span-4 bg-gray-800 p-6 rounded-xl shadow-lg fade-in" style="animation-delay: 0.4s;">
            <h2 class="text-xl font-semibold text-white mb-4">Динамика баланса (USD) - Почасовая</h2>
            <div class="h-80">
                <canvas id="balanceChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Transactions History -->
    <div class="bg-gray-800 p-6 rounded-xl shadow-lg fade-in mt-6" style="animation-delay: 0.5s;">
        <h2 class="text-xl font-semibold text-white mb-4">История транзакций</h2>
        <div class="overflow-x-auto max-h-96">
            <table class="w-full text-left">
                <thead class="sticky top-0 bg-gray-800 z-10">
                <tr>
                    <th class="p-3 text-sm font-semibold text-gray-400">Дата</th>
                    <th class="p-3 text-sm font-semibold text-gray-400">Пара</th>
                    <th class="p-3 text-sm font-semibold text-gray-400">Тип</th>
                    <th class="p-3 text-sm font-semibold text-gray-400">Цена</th>
                    <th class="p-3 text-sm font-semibold text-gray-400">Количество</th>
                    <th class="p-3 text-sm font-semibold text-gray-400">Сумма</th>
                </tr>
                </thead>
                <tbody id="transactions-table-body">
                <tr id="no-transactions-row"><td colspan="6" class="text-center p-8 text-gray-500">Загрузка данных о транзакциях...</td></tr>
                </tbody>
            </table>
        </div>
    </div>

    <footer class="text-center text-gray-500 mt-8">
        <p>Прототип для проекта на Raspberry Pi + Java. © 2025</p>
    </footer>
</div>

<script>
    lucide.createIcons();

    document.addEventListener('DOMContentLoaded', () => {
        const elements = {
            totalBalanceUsd: document.getElementById('total-balance-usd'),
            totalBalanceBtc: document.getElementById('total-balance-btc'),
            pnlValue: document.getElementById('pnl-value'),
            pnlPercentage: document.getElementById('pnl-percentage'),
            pnlIconContainer: document.getElementById('pnl-icon-container'),
            buyTrades: document.getElementById('buy-trades'),
            sellTrades: document.getElementById('sell-trades'),
            lastUpdate: document.getElementById('last-update-time'),
            transactionsTableBody: document.getElementById('transactions-table-body'),
            apiStatusIndicator: document.getElementById('api-status-indicator'),
            apiStatusText: document.getElementById('api-status-text'),
            balanceChartCanvas: document.getElementById('balanceChart'),
        };

        const API_BALANCE_URL = '/api/balance';
        const API_HISTORY_URL = '/api/balance/history';

        const formatCurrency = (value, currency = 'USD') => new Intl.NumberFormat('en-US', { style: 'currency', currency: currency, minimumFractionDigits: 2, maximumFractionDigits: currency === 'BTC' ? 8 : 2 }).format(value);
        const formatNumber = (value) => parseFloat(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 8 });

        // Initialize the main balance chart
        const balanceChart = new Chart(elements.balanceChartCanvas.getContext('2d'), {
            type: 'line',
            data: {
                datasets: [{
                    label: 'Баланс (USD)',
                    data: [],
                    borderColor: 'rgba(59, 130, 246, 0.8)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    fill: true,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 0,
                    pointHoverRadius: 5,
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'hour',
                            tooltipFormat: 'dd MMM, HH:mm',
                            displayFormats: {
                                hour: 'HH:00'
                            }
                        },
                        grid: { display: false },
                        ticks: { color: '#9ca3af' }
                    },
                    y: {
                        beginAtZero: false,
                        grid: { color: 'rgba(255, 255, 255, 0.1)' },
                        ticks: {
                            color: '#9ca3af',
                            callback: (value) => `$${value.toLocaleString()}`
                        }
                    }
                },
                plugins: { legend: { display: false } }
            }
        });

        function updateDashboardUI(data) {
            // Update widgets
            elements.totalBalanceUsd.textContent = formatCurrency(data.totalUsd || 0);
            elements.totalBalanceBtc.textContent = `~${(data.totalBtc || 0).toFixed(6)} BTC`;

            const pnl = data.pnl || { value: 0, percentage: 0 };
            const isProfit = pnl.value >= 0;
            elements.pnlValue.textContent = formatCurrency(pnl.value);
            elements.pnlPercentage.textContent = `${pnl.percentage.toFixed(2)}%`;
            elements.pnlValue.className = `text-4xl font-bold mt-4 ${isProfit ? 'text-green-500' : 'text-red-500'}`;
            elements.pnlPercentage.className = `text-lg mt-1 ${isProfit ? 'text-green-500' : 'text-red-500'}`;
            elements.pnlIconContainer.innerHTML = `<i data-lucide="${isProfit ? 'trending-up' : 'trending-down'}"></i>`;
            elements.pnlIconContainer.className = `p-2 rounded-lg ${isProfit ? 'bg-green-500/20 text-green-400' : 'bg-red-500/20 text-red-400'}`;

            const trades24h = data.trades || { buys: 0, sells: 0 };
            elements.buyTrades.textContent = trades24h.buys;
            elements.sellTrades.textContent = trades24h.sells;

            // Update transactions table
            elements.transactionsTableBody.innerHTML = '';
            if (!data.transactions || data.transactions.length === 0) {
                elements.transactionsTableBody.innerHTML = `<tr><td colspan="6" class="text-center p-8 text-gray-500">Нет данных о транзакциях.</td></tr>`;
            } else {
                data.transactions.forEach(tx => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-700 hover:bg-gray-700/50';
                    const typeClass = tx.type === 'buy' ? 'text-green-400' : 'text-red-400';
                    row.innerHTML = `
                        <td class="p-3 text-sm text-gray-300">${new Date(tx.date * 1000).toLocaleString('ru-RU')}</td>
                        <td class="p-3 font-medium text-white">${tx.pair}</td>
                        <td class="p-3 font-semibold ${typeClass}">${tx.type.toUpperCase()}</td>
                        <td class="p-3 text-gray-300">${formatNumber(tx.price)}</td>
                        <td class="p-3 text-gray-300">${formatNumber(tx.quantity)}</td>
                        <td class="p-3 font-medium text-white">${formatNumber(tx.amount)}</td>
                    `;
                    elements.transactionsTableBody.appendChild(row);
                });
            }

            lucide.createIcons();
        }

        async function fetchChartHistory() {
            try {
                const response = await fetch(API_HISTORY_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const historyData = await response.json();

                const chartPoints = historyData.map(point => ({
                    x: point.timestamp,
                    y: point.balance
                }));

                balanceChart.data.datasets[0].data = chartPoints;
                balanceChart.update();

            } catch(error) {
                console.error("Не удалось загрузить историю для графика:", error);
            }
        }

        async function fetchRealtimeData() {
            try {
                const response = await fetch(API_BALANCE_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                if (data.error) throw new Error(data.error);

                elements.apiStatusIndicator.className = 'w-3 h-3 rounded-full bg-green-500';
                elements.apiStatusText.textContent = 'Подключено';
                elements.apiStatusIndicator.classList.remove('animate-pulse');
                elements.lastUpdate.textContent = new Date().toLocaleTimeString('ru-RU');

                updateDashboardUI(data);

                // Add latest point to chart
                const lastDataPoint = balanceChart.data.datasets[0].data.at(-1);
                if (!lastDataPoint || lastDataPoint.y !== data.totalUsd) {
                     balanceChart.data.datasets[0].data.push({x: Date.now(), y: data.totalUsd});
                     balanceChart.update('none'); // 'none' for no animation
                }

            } catch (error) {
                console.error("Ошибка при получении данных:", error);
                elements.apiStatusIndicator.className = 'w-3 h-3 rounded-full bg-red-500 animate-pulse';
                elements.apiStatusText.textContent = 'Ошибка API';
                elements.lastUpdate.textContent = 'ошибка';
            }
        }

        // Initial fetch and start interval
        fetchChartHistory().then(() => {
            fetchRealtimeData(); // Fetch live data after history is loaded
            setInterval(fetchRealtimeData, 30000); // Refresh data every 30 seconds
        });
    });
</script>
</body>
</html>
